<!-- filepath: /D:/PLANILHA_PRECIFICACAO/Empresa_Referencia_PP/cadastro_equipe/templates/composicao_equipe.html -->
{% extends 'base.html' %}

{% block content %}
    <div class="header">Cadastrar Equipes</div>

    <p class="text-center mt-0 font-weight-bold" style="font-size: 0.8rem; border-bottom: 2px solid #483D8B;"> </p>
    <!-- Campos lado a lado -->
    <div class="row align-items-end">
        <div class="col-md-3">
            <label class="form-label">Tipo de Equipe:</label>
            <select id="equipe" class="form-control form-control-sm">
                {% for equipe in equipes %}
                    <option value="{{ equipe.id }}">{{ equipe.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Quantidade de Equipes:</label>
            <input type="number" id="quantidade_equipes" class="form-control form-control-sm" min="1" value="1">
        </div>
        <div class="col-md-6">
            <label class="form-label">Observação:</label>
            <input type="text" id="observacao" class="form-control form-control-sm">
        </div>
    </div>

    <!-- Handsontable para inserir dados -->
    <div id="tabela_composicao" class="table-responsive mt-3"></div>

    <div class="d-flex justify-content-end">
        <button id="adicionar" class="btn btn-primary mt-3">+ Adicionar</button>
    </div>

    <div class="small-header"> Equipes Cadastradas </div>
    <p class="text-center mt-0 font-weight-bold" style="font-size: 0.8rem; border-bottom: 1px solid #483D8B;"> </p>
    
    <div class="row mt-2">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <thead style="background-color: #483D8B; color: white; height: 35px;">
                            <tr>
                                <th>ID - Contrato</th>
                                <th>Equipe</th>
                                <th>Quantidade</th>
                                <th>Total Funcionários</th>
                                <th>Observação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for composicao in composicoes %}
                                <tr>
                                    <td>{{ composicao.contrato_id }} - {{ composicao.contrato.escopo_contrato }}</td>
                                    <td>{{ composicao.equipe.nome }}</td>
                                    <td>{{ composicao.quantidade_equipes }}</td>
                                    <td>{{ composicao.total_funcionarios }}</td>
                                    <td>{{ composicao.observacao }}</td>
                                    <td>
                                        <a href="{% url 'detalhes_composicao' composicao.pk %}" class="btn btn-info btn-sm ver">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-primary btn-sm editar" data-id="{{ composicao.pk }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm excluir" data-id="{{ composicao.pk }}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>  
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">Nenhuma composição cadastrada.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Handsontable -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.js"></script>

    <style>
        .header {
            background-color:rgb(231, 229, 247);
            color: #483D8B;
            text-align: center;
            padding: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 5px;
        }

        .small-header {
            background-color:rgb(231, 229, 247);
            color: #483D8B;
            text-align: center;
            padding: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 5px;
        }

        #tabela_composicao {
            width: 100%;
            min-height: 300px;
            border: 1px solid #ccc;
            margin-top: 10px;
            border-radius: 5px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .ht_clone_top thead th {
            text-align: center;
            background-color: #483D8B;
            color: white;
            height: auto !important; 
            white-space: nowrap;
            padding: 2px 3px; /* Ajusta o espaçamento interno */
            line-height: normal !important; /* Mantém o texto corretamente centralizado */
        }
        .htEditable { background-color: #FFF2CC !important; border: 1px solid #ced4da; }
        .htReadOnly { background-color: #E6E6E6 !important; color: black !important; }
        .card-header { background-color: #483D8B; color: white; text-align: center; font-weight: bold; font-size: 14px; padding: 5px 10px; }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var container = document.getElementById("tabela_composicao");
            var data = [
                {% for funcao in funcoes %} 
                    ["{{ funcao.nome }}", 0, "{{ funcao.salario }}", false, 0, 0, 0, 0, 0, 0], 
                {% endfor %}
            ];
        
            var hot = new Handsontable(container, {
                data: data,
                colHeaders: [
                    'Função', 'Quantidade', 'Salário', 'Periculosidade', 
                    'Horas Extras 50%', 'Horas Extras 70%', 'Horas Extras 100%', 
                    'Horas Sobreaviso', 'Horas Adicional Noturno', 'Outros Custos'
                ],
                columns: [
                    { type: 'text', readOnly: true, className: 'htReadOnly' },  
                    { type: 'numeric', className: 'htEditable' },                
                    { type: 'numeric', readOnly: true, className: 'htReadOnly' }, 
                    { type: 'checkbox', className: 'htEditable' },              
                    { type: 'numeric', className: 'htEditable' },               
                    { type: 'numeric', className: 'htEditable' },               
                    { type: 'numeric', className: 'htEditable' },               
                    { type: 'numeric', className: 'htEditable' },               
                    { type: 'numeric', className: 'htEditable' },               
                    { type: 'numeric', className: 'htEditable' }
                ],
                rowHeaders: true,
                minSpareRows: 1,
                contextMenu: true,
                autoColumnSize: true,
                stretchH: 'all',
                licenseKey: 'non-commercial-and-evaluation'
            });

            let isEditing = false;
            let editingId = null;
        
            document.getElementById("adicionar").addEventListener("click", function() {
                var contratoId = "{{ contrato_id }}";
                var equipeId = document.getElementById("equipe").value;
                var quantidadeEquipes = document.getElementById("quantidade_equipes").value;
                var observacao = document.getElementById("observacao").value;

                var tabelaDados = hot.getData();
                var dadosFormatados = tabelaDados
                    .filter(row => row[0] && row[0].trim() !== "")
                    .map(row => ({
                        funcao: row[0].trim(),
                        quantidade: row[1] || 0,
                        salario: row[2] || 0.00,
                        periculosidade: row[3] || false,
                        horas_extras_50: row[4] || 0,
                        horas_extras_70: row[5] || 0,
                        horas_extras_100: row[6] || 0,
                        horas_sobreaviso: row[7] || 0,
                        horas_adicional_noturno: row[8] || 0,
                        outros_custos: row[9] || 0.00
                    }));

                const url = isEditing ? `/cadastro_equipe/composicao/${editingId}/editar/` : "{% url 'composicao_equipe' contrato_id %}";
                const method = isEditing ? "PUT" : "POST";

                fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                    body: JSON.stringify({
                        contrato_id: contratoId,
                        equipe_id: equipeId,
                        quantidade_equipes: quantidadeEquipes,
                        observacao: observacao,
                        dados: dadosFormatados
                    })
                })
                .then(() => { 
                    alert("Composição salva com sucesso!"); 
                    window.location.reload(); 
                })
                .catch(error => console.error("Erro ao salvar:", error));
            });

            // Função para excluir composição
            document.querySelectorAll(".excluir").forEach(button => {
                button.addEventListener("click", function() {
                    const composicaoId = this.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir esta composição?")) {
                        fetch(`/cadastro_equipe/composicao/${composicaoId}/excluir/`, {
                            method: "DELETE",
                            headers: { "X-CSRFToken": "{{ csrf_token }}" }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === "success") {
                                alert("Composição excluída com sucesso!");
                                window.location.reload();
                            } else {
                                alert("Erro ao excluir composição: " + data.message);
                            }
                        })
                        .catch(error => console.error("Erro ao excluir:", error));
                    }
                });
            });

            // Função para editar composição
            document.querySelectorAll(".editar").forEach(button => {
                button.addEventListener("click", function() {
                    const composicaoId = this.getAttribute("data-id");
                    isEditing = true;
                    editingId = composicaoId;

                    // Carregar dados da composição na tabela
                    fetch(`/cadastro_equipe/composicao/${composicaoId}/`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById("equipe").value = data.equipe_id;
                            document.getElementById("quantidade_equipes").value = data.quantidade_equipes;
                            document.getElementById("observacao").value = data.observacao;

                            const tabelaDados = data.dados.map(row => [
                                row.funcao,
                                row.quantidade,
                                row.salario,
                                row.periculosidade,
                                row.horas_extras_50,
                                row.horas_extras_70,
                                row.horas_extras_100,
                                row.horas_sobreaviso,
                                row.horas_adicional_noturno,
                                row.outros_custos
                            ]);

                            hot.loadData(tabelaDados);

                            // Habilitar edição na tabela
                            hot.updateSettings({
                                cells: function (row, col) {
                                    const cellProperties = {};
                                    if (col !== 0 && col !== 2) { // Permitir edição em todas as colunas, exceto Função e Salário
                                        cellProperties.readOnly = false;
                                        cellProperties.className = 'htEditable';
                                    } else {
                                        cellProperties.readOnly = true;
                                        cellProperties.className = 'htReadOnly';
                                    }
                                    return cellProperties;
                                }
                            });

                            alert("Edição habilitada para a composição: " + composicaoId);
                        })
                        .catch(error => console.error("Erro ao carregar dados da composição:", error));
                });
            });

            // Função para ver detalhes da composição
            document.querySelectorAll(".ver").forEach(button => {
                button.addEventListener("click", function(event) {
                    event.preventDefault();
                    const url = this.getAttribute("href");
                    const width = 800;
                    const height = 600;
                    const left = (screen.width - width) / 2;
                    const top = (screen.height - height) / 2;
                    window.open(url, "Detalhes da Composição", `width=${width},height=${height},top=${top},left=${left}`);
                });
            });
        });
    </script>
{% endblock %}