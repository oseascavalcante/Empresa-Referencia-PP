{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-users-cog me-3"></i>
                Cadastro de Equipes
            </h1>
            <p class="hero-subtitle">Configure a composição das equipes de trabalho</p>
        </div>
        <div class="hero-info">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Contrato:</span>
                    <span class="info-value">{{ contrato.contrato }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Concessionária:</span>
                    <span class="info-value">{{ contrato.concessionaria }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lote:</span>
                    <span class="info-value">{{ contrato.municipio }} - {{ contrato.estado }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Vigência:</span>
                    <span class="info-value">{{ contrato.inicio_vigencia_contrato|date:"d/m/Y" }} a {{ contrato.fim_vigencia_contrato|date:"d/m/Y" }}</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Formulário Principal -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="main-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Composição de Equipe
                    </h5>
                    <div class="card-actions d-flex gap-2">
                        <button type="button" class="btn btn-warning btn-sm" id="limpar-tabela">
                            <i class="fas fa-broom"></i> Limpar Tudo
                        </button>
                        <button type="button" class="btn btn-info btn-sm" id="cole-excel-btn">
                            <i class="fas fa-file-excel"></i> Cole do Excel
                        </button>
                        <button type="button" class="btn btn-success btn-sm" id="salvar-btn">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Alert container -->
                    <div id="alert-container" class="mb-3"></div>
                    
                    <!-- Área de importação do Excel removida - agora está em seção separada -->
                    
                    <!-- Formulário de configuração da equipe -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label for="regional" class="form-label">Regional *</label>
                            <select id="regional" class="form-select" required>
                                <option value="">Selecione</option>
                                {% for regional in regionais %}
                                    <option value="{{ regional.id }}">{{ regional.nome }} - {{ regional.municipio }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="id_escopo" class="form-label">Escopo da Atividade *</label>
                            <select id="id_escopo" name="escopo" class="form-select" required>
                                <option value="">Selecione</option>
                                {% for escopo in escopos %}
                                <option value="{{ escopo.id }}">{{ escopo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="equipe" class="form-label">Tipo de Equipe *</label>
                            <select id="equipe" class="form-select" required>
                                <option value="">Selecione</option>
                                {% for equipe in equipes %}
                                    <option value="{{ equipe.id }}">{{ equipe.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="quantidade_equipes" class="form-label">Qtd. Equipes *</label>
                            <input type="number" id="quantidade_equipes" class="form-control" min="1" value="1" required>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="data_mobilizacao" class="form-label">Data Mobilização *</label>
                            <input type="date" id="data_mobilizacao" class="form-control" required 
                                   value="{{ contrato.inicio_vigencia_contrato|date:'Y-m-d' }}">
                        </div>
                        
                        <div class="col-md-2">
                            <label for="data_desmobilizacao" class="form-label">Data Desmobilização *</label>
                            <input type="date" id="data_desmobilizacao" class="form-control" required 
                                   value="{{ contrato.fim_vigencia_contrato|date:'Y-m-d' }}">
                        </div>
                        
                        <div class="col-12">
                            <label for="observacao" class="form-label">Observações</label>
                            <input type="text" id="observacao" class="form-control" 
                                   placeholder="Informações adicionais sobre a equipe...">
                        </div>
                    </div>

                    <!-- Tabela de composição customizada -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="composicao-table">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 18%">Função</th>
                                    <th style="width: 8%">Qtd.</th>
                                    <th style="width: 10%">Salário (R$)</th>
                                    <th style="width: 8%">Peric.</th>
                                    <th style="width: 9%">H.E. 50%</th>
                                    <th style="width: 9%">H. Pront.</th>
                                    <th style="width: 9%">H.E. 100%</th>
                                    <th style="width: 9%">H. Sobr.</th>
                                    <th style="width: 9%">H. Not.</th>
                                    <th style="width: 9%">Outros</th>
                                    <th style="width: 6%">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="composicao-tbody">
                                {% for funcao in funcoes %}
                                <tr data-funcao="{{ funcao.nome }}">
                                    <td>
                                        <input type="text" class="form-control funcao-nome" 
                                               value="{{ funcao.nome }}" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-quantidade" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-salario" 
                                               value="{{ funcao.salario }}" step="0.01" placeholder="Salário será carregado automaticamente">
                                    </td>
                                    <td>
                                        <div class="form-check d-flex justify-content-center">
                                            <input type="checkbox" class="form-check-input funcao-periculosidade">
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-he50" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-prontidao" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-he100" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-sobreaviso" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-noturno" 
                                               value="0" min="0" placeholder="0">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control funcao-outros" 
                                               value="0" step="0.01" min="0" placeholder="0.00">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger remover-linha" title="Limpar">
                                            <i class="fas fa-eraser"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-start align-items-center mt-3">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Área de importação do Excel movida para cá -->
    <div class="row mt-4" id="excel-import-container" style="display: none;">
        <div class="col-12">
            <div class="main-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-excel me-2"></i>
                        Importar do Excel
                    </h5>
                    <button type="button" class="btn btn-sm btn-secondary" id="fechar-excel">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <div class="card-body">
                    <div class="excel-format-info">
                        <strong>Formato esperado:</strong>
                        <code>Função | Quantidade | Salário | Periculosidade | Horas Extras 50% | Horas Prontidão | Horas Extras 100% | Horas Sobreaviso | Horas Adicional Noturno | Outros Custos</code>
                        <br><small class="text-muted">Aceita separadores: TAB, ponto e vírgula (;), vírgula (,) ou pipe (|)</small>
                    </div>
                    <textarea id="excel-data-external" class="form-control mt-3" rows="8" 
                              placeholder="Cole os dados do Excel aqui...&#10;Exemplo:&#10;Técnico&#9;2&#9;3500&#9;true&#9;10&#9;5&#9;2&#9;8&#9;4&#9;100"></textarea>
                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-primary" id="processar-excel-external">
                            <i class="fas fa-cogs"></i> Processar Dados
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelar-excel-external">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Equipes Cadastradas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="main-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Equipes Cadastradas
                    </h5>
                    <div class="badge bg-primary" id="contador-equipes" style="font-size: 1.1rem; font-weight: 600;">
                        <span id="total-pessoas">0</span> pessoas
                    </div>
                </div>
                
                <div class="card-body p-0">
                    {% if composicoes %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="equipes-cadastradas-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Contrato</th>
                                        <th>Regional</th>
                                        <th>Escopo</th>
                                        <th>Equipe</th>
                                        <th>Quantidade</th>
                                        <th>Pessoas/Equipe</th>
                                        <th>Observação</th>
                                        <th style="width: 120px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for composicao in composicoes %}
                                        <tr>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-bold">{{ composicao.contrato.contrato }}</span>
                                                    <small class="text-muted">{{ composicao.contrato.escopo_contrato }}</small>
                                                </div>
                                            </td>
                                            <td>{{ composicao.regional.nome }}</td>
                                            <td>{{ composicao.escopo.nome }}</td>
                                            <td>{{ composicao.equipe.nome }}</td>
                                            <td>{{ composicao.quantidade_equipes }}</td>
                                            <td>{{ composicao.total_funcionarios }}</td>
                                            <td>
                                                {% if composicao.observacao %}
                                                    <span class="text-truncate" title="{{ composicao.observacao }}">{{ composicao.observacao|truncatechars:30 }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-info ver" 
                                                            data-url="{% url 'detalhes_equipe' composicao.pk %}" title="Ver detalhes">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-warning editar" 
                                                            data-id="{{ composicao.pk }}" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger excluir" 
                                                            data-id="{{ composicao.pk }}" title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-users text-muted"></i>
                            </div>
                            <h6 class="text-muted">Nenhuma equipe cadastrada</h6>
                            <p class="text-muted small">Configure uma equipe acima para começar</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<style>
/* CSS Moderno para Cadastro de Equipes */
:root {
    --primary-color: #483D8B;
    --secondary-color: #6A5ACD;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
}

/* Hero Section - Compactado */
.hero-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    background-color: rgba(72, 61, 139, 0.9);
}

/* Logomarca removida conforme solicitação */

.hero-content {
    position: relative;
    z-index: 1;
}

.hero-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.hero-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.info-item {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: center;
}

.info-label {
    font-size: 0.85rem;
    opacity: 0.8;
    font-weight: 500;
}

.info-value {
    font-weight: 600;
    font-size: 0.95rem;
}

/* Cards Modernos */
.main-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(72, 61, 139, 0.1);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.main-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card-header {
    background: var(--primary-color);
    color: white;
    padding: 1rem 1.5rem;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-actions {
    display: flex;
    gap: 0.5rem;
}

/* Formulário */
.form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(72, 61, 139, 0.25);
}

/* Tabela Customizada */
#composicao-table {
    border-radius: 8px;
    overflow: hidden;
}

#composicao-table .table-dark {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
}

.table-dark {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
    color: white !important;
}

#composicao-table input {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

#composicao-table input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.1rem rgba(72, 61, 139, 0.25);
}

#composicao-table input[readonly] {
    background-color: #f8f9fa;
    color: #6c757d;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

/* Excel Import */
.excel-import-card {
    border: 2px dashed var(--info-color);
    border-radius: 12px;
    padding: 1.5rem;
    background: rgba(23, 162, 184, 0.05);
}

.excel-import-header {
    margin-bottom: 1rem;
}

.excel-import-header h6 {
    color: var(--info-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.excel-format-info {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.excel-format-info code {
    background: rgba(255, 255, 255, 0.8);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

.excel-import-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
}

/* Botões */
.btn {
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

/* Badges */
.badge {
    font-weight: 500;
    border-radius: 6px;
}

/* Responsividade */
@media (max-width: 768px) {
    .hero-title {
        font-size: 1.5rem;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .card-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .card-actions {
        justify-content: center;
    }
    
    #composicao-table {
        font-size: 0.8rem;
    }
    
    #composicao-table input {
        padding: 0.2rem 0.3rem;
    }
}

/* Animações */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.main-card {
    animation: fadeIn 0.5s ease-out;
}

/* Alertas customizados */
.alert {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
</style>

<script>
// JavaScript Moderno para Cadastro de Equipes
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token }}';
    const contratoId = '{{ contrato_id }}';
    let isEditing = false;
    let editingId = null;
    
    // Elementos DOM
    const alertContainer = document.getElementById('alert-container');
    const excelImportArea = document.getElementById('excel-import-area');
    const excelDataTextarea = document.getElementById('excel-data');
    const excelImportContainer = document.getElementById('excel-import-container');
    const excelDataExternal = document.getElementById('excel-data-external');
    const composicaoTable = document.getElementById('composicao-table');
    const composicaoTbody = document.getElementById('composicao-tbody');
    
    // Função para calcular e atualizar contador de pessoas
    function atualizarContadorPessoas() {
        // Calcular total de pessoas dinamicamente da página atual
        let totalPessoas = 0;
        const linhasTabela = document.querySelectorAll('#equipes-cadastradas-table tbody tr');
        
        linhasTabela.forEach(linha => {
            const pessoasCell = linha.querySelector('td:nth-child(6)'); // Coluna "Pessoas/Equipe"
            if (pessoasCell) {
                const pessoas = parseInt(pessoasCell.textContent.trim()) || 0;
                totalPessoas += pessoas;
            }
        });
        
        const contadorElement = document.getElementById('total-pessoas');
        if (contadorElement) {
            contadorElement.textContent = totalPessoas;
        }
    }
    
    // Função para buscar salário da função via AJAX
    function buscarSalarioFuncao(funcaoNome, callback) {
        // Procurar na lista de funções usando dados do template
        const funcoes = JSON.parse('{{ funcoes_json|safe }}');
        const funcaoEncontrada = funcoes.find(f => f.nome.toLowerCase() === funcaoNome.toLowerCase());
        
        if (funcaoEncontrada) {
            callback({
                success: true,
                salario: parseFloat(funcaoEncontrada.salario),
                nome: funcaoEncontrada.nome
            });
        } else {
            callback({
                success: false,
                error: 'Função não encontrada'
            });
        }
    }
    
    // Event listener para auto-preenchimento de salário
    composicaoTbody.addEventListener('input', function(e) {
        if (e.target.classList.contains('funcao-nome')) {
            const row = e.target.closest('tr');
            const salarioInput = row.querySelector('.funcao-salario');
            const funcaoNome = e.target.value.trim();
            
            if (funcaoNome && salarioInput && !salarioInput.dataset.userModified) {
                buscarSalarioFuncao(funcaoNome, function(response) {
                    if (response.success) {
                        salarioInput.value = response.salario.toFixed(2);
                        // Visual feedback
                        salarioInput.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            salarioInput.style.backgroundColor = '';
                        }, 1000);
                    }
                });
            }
        }
        
        if (e.target.classList.contains('funcao-salario')) {
            // Marcar que o usuário modificou o salário manualmente
            e.target.dataset.userModified = 'true';
        }
    });
    
    // Inicializar contador
    atualizarContadorPessoas();
    
    // Função para mostrar alertas
    function showAlert(message, type = 'info') {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
    
    // Função para coletar dados da tabela
    function coletarDadosTabela() {
        const rows = composicaoTbody.querySelectorAll('tr');
        const dados = [];
        
        rows.forEach(row => {
            const funcao = row.querySelector('.funcao-nome').value.trim();
            const quantidade = parseInt(row.querySelector('.funcao-quantidade').value) || 0;
            
            if (funcao && quantidade > 0) {
                dados.push({
                    funcao: funcao,
                    quantidade: quantidade,
                    salario: parseFloat(row.querySelector('.funcao-salario').value) || 0,
                    periculosidade: row.querySelector('.funcao-periculosidade').checked,
                    horas_extras_50: parseInt(row.querySelector('.funcao-he50').value) || 0,
                    horas_prontidao: parseInt(row.querySelector('.funcao-prontidao').value) || 0,
                    horas_extras_100: parseInt(row.querySelector('.funcao-he100').value) || 0,
                    horas_sobreaviso: parseInt(row.querySelector('.funcao-sobreaviso').value) || 0,
                    horas_adicional_noturno: parseInt(row.querySelector('.funcao-noturno').value) || 0,
                    outros_custos: parseFloat(row.querySelector('.funcao-outros').value) || 0
                });
            }
        });
        
        return dados;
    }
    
    // Função para validar formulário
    function validarFormulario() {
        const regional = document.getElementById('regional').value;
        const escopo = document.getElementById('id_escopo').value;
        const equipe = document.getElementById('equipe').value;
        const quantidade = document.getElementById('quantidade_equipes').value;
        const dataMob = document.getElementById('data_mobilizacao').value;
        const dataDesm = document.getElementById('data_desmobilizacao').value;
        
        if (!regional || !escopo || !equipe || !quantidade || !dataMob || !dataDesm) {
            showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
            return false;
        }
        
        const dados = coletarDadosTabela();
        if (dados.length === 0) {
            showAlert('Configure pelo menos uma função com quantidade maior que zero.', 'warning');
            return false;
        }
        
        return true;
    }
    
    // Toggle área de importação Excel externa
    document.getElementById('cole-excel-btn').addEventListener('click', function() {
        excelImportContainer.style.display = excelImportContainer.style.display === 'none' ? 'block' : 'none';
        // Esconder a área interna se estiver visível
        if (excelImportArea) {
            excelImportArea.style.display = 'none';
        }
    });
    
    // Fechar área Excel externa
    document.getElementById('fechar-excel').addEventListener('click', function() {
        excelImportContainer.style.display = 'none';
        excelDataExternal.value = '';
    });
    
    // Cancelar importação Excel
    document.getElementById('cancelar-excel').addEventListener('click', function() {
        excelImportArea.style.display = 'none';
        excelDataTextarea.value = '';
    });
    
    // Cancelar importação Excel externa
    document.getElementById('cancelar-excel-external').addEventListener('click', function() {
        excelImportContainer.style.display = 'none';
        excelDataExternal.value = '';
    });
    
    // Processar dados do Excel
    document.getElementById('processar-excel').addEventListener('click', function() {
        const data = excelDataTextarea.value.trim();
        if (!data) {
            showAlert('Por favor, cole os dados do Excel na área de texto.', 'warning');
            return;
        }
        
        const lines = data.split(/\r?\n/);
        let processedLines = 0;
        
        // Limpar dados atuais da tabela
        const rows = composicaoTbody.querySelectorAll('tr');
        rows.forEach(row => {
            row.querySelector('.funcao-quantidade').value = '0';
            row.querySelector('.funcao-periculosidade').checked = false;
            row.querySelector('.funcao-he50').value = '0';
            row.querySelector('.funcao-prontidao').value = '0';
            row.querySelector('.funcao-he100').value = '0';
            row.querySelector('.funcao-sobreaviso').value = '0';
            row.querySelector('.funcao-noturno').value = '0';
            row.querySelector('.funcao-outros').value = '0';
        });
        
        lines.forEach((line, lineIndex) => {
            if (!line.trim()) return;
            
            // Detectar separador
            let cols = line.split('\t');
            if (cols.length === 1) cols = line.split(';');
            if (cols.length === 1) cols = line.split(',');
            if (cols.length === 1) cols = line.split('|');
            
            cols = cols.map(col => col.trim());
            
            if (cols.length >= 2 && cols[0]) {
                // Procurar linha correspondente na tabela
                const funcaoNome = cols[0];
                const targetRow = Array.from(rows).find(row => 
                    row.querySelector('.funcao-nome').value.toLowerCase().includes(funcaoNome.toLowerCase())
                );
                
                if (targetRow) {
                    if (cols[1]) targetRow.querySelector('.funcao-quantidade').value = cols[1];
                    if (cols[3]) targetRow.querySelector('.funcao-periculosidade').checked = 
                        cols[3].toLowerCase() === 'true' || cols[3] === '1';
                    if (cols[4]) targetRow.querySelector('.funcao-he50').value = cols[4];
                    if (cols[5]) targetRow.querySelector('.funcao-prontidao').value = cols[5];
                    if (cols[6]) targetRow.querySelector('.funcao-he100').value = cols[6];
                    if (cols[7]) targetRow.querySelector('.funcao-sobreaviso').value = cols[7];
                    if (cols[8]) targetRow.querySelector('.funcao-noturno').value = cols[8];
                    if (cols[9]) targetRow.querySelector('.funcao-outros').value = cols[9];
                    
                    processedLines++;
                }
            }
        });
        
        excelImportArea.style.display = 'none';
        excelDataTextarea.value = '';
        showAlert(`${processedLines} linha(s) processada(s) com sucesso!`, 'success');
    });
    
    // Processar dados do Excel (área externa)
    document.getElementById('processar-excel-external').addEventListener('click', function() {
        const data = excelDataExternal.value.trim();
        if (!data) {
            showAlert('Por favor, cole os dados do Excel na área de texto.', 'warning');
            return;
        }
        
        const lines = data.split(/\r?\n/);
        let processedLines = 0;
        
        // Limpar dados atuais da tabela
        const rows = composicaoTbody.querySelectorAll('tr');
        rows.forEach(row => {
            row.querySelector('.funcao-quantidade').value = '0';
            row.querySelector('.funcao-periculosidade').checked = false;
            row.querySelector('.funcao-he50').value = '0';
            row.querySelector('.funcao-prontidao').value = '0';
            row.querySelector('.funcao-he100').value = '0';
            row.querySelector('.funcao-sobreaviso').value = '0';
            row.querySelector('.funcao-noturno').value = '0';
            row.querySelector('.funcao-outros').value = '0';
        });
        
        lines.forEach((line, lineIndex) => {
            if (!line.trim()) return;
            
            // Detectar separador
            let cols = line.split('\t');
            if (cols.length === 1) cols = line.split(';');
            if (cols.length === 1) cols = line.split(',');
            if (cols.length === 1) cols = line.split('|');
            
            cols = cols.map(col => col.trim());
            
            if (cols.length >= 2 && cols[0]) {
                // Procurar linha correspondente na tabela
                const funcaoNome = cols[0];
                const targetRow = Array.from(rows).find(row => 
                    row.querySelector('.funcao-nome').value.toLowerCase().includes(funcaoNome.toLowerCase())
                );
                
                if (targetRow) {
                    if (cols[1]) targetRow.querySelector('.funcao-quantidade').value = cols[1];
                    if (cols[3]) targetRow.querySelector('.funcao-periculosidade').checked = 
                        cols[3].toLowerCase() === 'true' || cols[3] === '1';
                    if (cols[4]) targetRow.querySelector('.funcao-he50').value = cols[4];
                    if (cols[5]) targetRow.querySelector('.funcao-prontidao').value = cols[5];
                    if (cols[6]) targetRow.querySelector('.funcao-he100').value = cols[6];
                    if (cols[7]) targetRow.querySelector('.funcao-sobreaviso').value = cols[7];
                    if (cols[8]) targetRow.querySelector('.funcao-noturno').value = cols[8];
                    if (cols[9]) targetRow.querySelector('.funcao-outros').value = cols[9];
                    
                    processedLines++;
                }
            }
        });
        
        excelImportContainer.style.display = 'none';
        excelDataExternal.value = '';
        showAlert(`${processedLines} linha(s) processada(s) com sucesso!`, 'success');
    });
    
    // Limpar tabela
    document.getElementById('limpar-tabela').addEventListener('click', function() {
        if (confirm('Deseja limpar todos os dados da tabela?')) {
            const rows = composicaoTbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.querySelector('.funcao-quantidade').value = '0';
                row.querySelector('.funcao-periculosidade').checked = false;
                row.querySelector('.funcao-he50').value = '0';
                row.querySelector('.funcao-prontidao').value = '0';
                row.querySelector('.funcao-he100').value = '0';
                row.querySelector('.funcao-sobreaviso').value = '0';
                row.querySelector('.funcao-noturno').value = '0';
                row.querySelector('.funcao-outros').value = '0';
            });
            showAlert('Tabela limpa com sucesso!', 'info');
        }
    });
    
    // Limpar linha individual
    document.addEventListener('click', function(e) {
        if (e.target.matches('.remover-linha, .remover-linha *')) {
            const row = e.target.closest('tr');
            row.querySelector('.funcao-quantidade').value = '0';
            row.querySelector('.funcao-periculosidade').checked = false;
            row.querySelector('.funcao-he50').value = '0';
            row.querySelector('.funcao-prontidao').value = '0';
            row.querySelector('.funcao-he100').value = '0';
            row.querySelector('.funcao-sobreaviso').value = '0';
            row.querySelector('.funcao-noturno').value = '0';
            row.querySelector('.funcao-outros').value = '0';
        }
    });
    
    // Salvar equipe
    document.getElementById('salvar-btn').addEventListener('click', function() {
        if (!validarFormulario()) return;
        
        if (!confirm('Deseja salvar a configuração da equipe?')) return;
        
        const dados = coletarDadosTabela();
        const formData = {
            contrato_id: contratoId,
            regional_id: document.getElementById('regional').value,
            escopo_id: document.getElementById('id_escopo').value,
            equipe_id: document.getElementById('equipe').value,
            quantidade_equipes: document.getElementById('quantidade_equipes').value,
            data_mobilizacao: document.getElementById('data_mobilizacao').value,
            data_desmobilizacao: document.getElementById('data_desmobilizacao').value,
            observacao: document.getElementById('observacao').value,
            dados: dados
        };
        
        const url = isEditing ? `/cadastro_equipe/composicao/${editingId}/editar/` : 
                                `{% url 'composicao_equipe' contrato_id %}`;
        const method = isEditing ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Erro desconhecido');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showAlert('Equipe salva com sucesso!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            }
        })
        .catch(error => {
            showAlert(`Erro ao salvar: ${error.message}`, 'danger');
        });
    });
    
    // Excluir composição
    document.addEventListener('click', function(e) {
        if (e.target.matches('.excluir, .excluir *')) {
            const composicaoId = e.target.closest('button').getAttribute('data-id');
            if (confirm('Tem certeza que deseja excluir esta equipe?')) {
                fetch(`/cadastro_equipe/composicao/${composicaoId}/excluir/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert('Equipe excluída com sucesso!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showAlert('Erro ao excluir equipe.', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Erro ao excluir equipe.', 'danger');
                });
            }
        }
    });
    
    // Editar composição
    document.addEventListener('click', function(e) {
        if (e.target.matches('.editar, .editar *')) {
            const composicaoId = e.target.closest('button').getAttribute('data-id');
            if (confirm('Deseja editar esta equipe? Os dados atuais serão substituídos.')) {
                carregarDadosEdicao(composicaoId);
            }
        }
    });
    
    // Ver detalhes
    document.addEventListener('click', function(e) {
        if (e.target.matches('.ver, .ver *')) {
            e.preventDefault();
            const url = e.target.closest('button').getAttribute('data-url');
            const width = 800;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(url, 'Detalhes da Equipe', `width=${width},height=${height},top=${top},left=${left}`);
        }
    });
    
    // Função para carregar dados de edição
    function carregarDadosEdicao(composicaoId) {
        fetch(`/cadastro_equipe/composicao/${composicaoId}/json/`)
        .then(response => response.json())
        .then(data => {
            isEditing = true;
            editingId = composicaoId;
            
            // Preencher formulário
            document.getElementById('regional').value = data.regional_id || '';
            document.getElementById('id_escopo').value = data.escopo_id || '';
            document.getElementById('equipe').value = data.equipe_id;
            document.getElementById('quantidade_equipes').value = data.quantidade_equipes;
            document.getElementById('data_mobilizacao').value = data.data_mobilizacao;
            document.getElementById('data_desmobilizacao').value = data.data_desmobilizacao;
            document.getElementById('observacao').value = data.observacao || '';
            
            // Limpar tabela
            const rows = composicaoTbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.querySelector('.funcao-quantidade').value = '0';
                row.querySelector('.funcao-periculosidade').checked = false;
                row.querySelector('.funcao-he50').value = '0';
                row.querySelector('.funcao-prontidao').value = '0';
                row.querySelector('.funcao-he100').value = '0';
                row.querySelector('.funcao-sobreaviso').value = '0';
                row.querySelector('.funcao-noturno').value = '0';
                row.querySelector('.funcao-outros').value = '0';
            });
            
            // Preencher dados da tabela
            data.dados.forEach(funcaoData => {
                const targetRow = Array.from(rows).find(row => 
                    row.querySelector('.funcao-nome').value === funcaoData.funcao
                );
                
                if (targetRow) {
                    targetRow.querySelector('.funcao-quantidade').value = funcaoData.quantidade;
                    targetRow.querySelector('.funcao-periculosidade').checked = funcaoData.periculosidade;
                    targetRow.querySelector('.funcao-he50').value = funcaoData.horas_extras_50;
                    targetRow.querySelector('.funcao-prontidao').value = funcaoData.horas_prontidao;
                    targetRow.querySelector('.funcao-he100').value = funcaoData.horas_extras_100;
                    targetRow.querySelector('.funcao-sobreaviso').value = funcaoData.horas_sobreaviso;
                    targetRow.querySelector('.funcao-noturno').value = funcaoData.horas_adicional_noturno;
                    targetRow.querySelector('.funcao-outros').value = funcaoData.outros_custos;
                }
            });
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showAlert('Dados carregados para edição. Modifique os campos necessários e clique em Salvar.', 'info');
        })
        .catch(error => {
            showAlert('Erro ao carregar dados da equipe.', 'danger');
        });
    }
});
</script>

{% endblock %}