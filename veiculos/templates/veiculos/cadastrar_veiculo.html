{% extends 'base.html' %}
{% load static %}

{% block title %}Parametrizar Veículos do Contrato{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-car-side me-3"></i>
                Parametrizar Veículos do Contrato
            </h1>
            <p class="hero-subtitle">Cadastro de Parâmetros Técnicos e Custos Operacionais</p>
        </div>
    </div>
        <div class="hero-info">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Contrato:</span>
                    <span class="info-value">{{ contrato.contrato }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Concessionária:</span>
                    <span class="info-value">{{ contrato.concessionaria }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lote:</span>
                    <span class="info-value">{{ contrato.municipio }} - {{ contrato.estado }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Vigência:</span>
                    <span class="info-value">{{ contrato.inicio_vigencia_contrato|date:"d/m/Y" }} a {{ contrato.fim_vigencia_contrato|date:"d/m/Y" }}</span>
                </div>
            </div>
        </div>

    <!-- Alerta se não há preços de combustível configurados -->
    {% if not veiculos.count %}
    <div class="alert alert-warning d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <div>
            <strong>Atenção:</strong> Configure os preços de combustível e tipos de veículos antes de cadastrar veículos.
            <a href="{% url 'configurar_precos_combustivel' contrato.pk %}" class="btn btn-sm btn-warning ms-2">
                <i class="fas fa-gas-pump me-1"></i>
                Configurar Preços
            </a>
            <a href="{% url 'cadastrar_tipo_veiculo' %}" class="btn btn-sm btn-info ms-2">
                <i class="fas fa-cogs me-1"></i>
                Cadastrar Tipos de Veículos
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Formulário de cadastro -->
    <div class="main-card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-plus-circle me-2"></i>
                Novo Veículo
            </h5>
            <button class="btn btn-light" 
                    hx-get="?fragment=form" 
                    hx-target="#veiculo-form"
                    hx-swap="innerHTML">
                <i class="fas fa-plus me-2"></i>
                Adicionar Veículo
            </button>
        </div>

        <!-- Container do formulário -->
        <div class="card-body">
            <div id="veiculo-form">
                <!-- Formulário será carregado aqui via HTMX -->
            </div>
        </div>
    </div>

    <!-- Lista de veículos cadastrados -->
    <div class="main-card mt-4" id="veiculos-section">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Veículos Cadastrados
            </h5>
            <div class="badge bg-primary" id="contador-veiculos" style="font-size: 1.1rem; font-weight: 600;">
                {{ veiculos.count }} veículo{{ veiculos.count|pluralize }}
            </div>
        </div>

        <!-- Tabela de veículos -->
        <div class="card-body p-0">
            <div id="lista-veiculos" class="table-responsive">
                {% include 'veiculos/_lista_veiculos_inline.html' %}
            </div>
        </div>
    </div>

</div>

<style>
/* CSS Moderno para Atribuição de Veículos - Copiado de composicao_equipe */
:root {
    --primary-color: #483D8B;
    --primary-light: #7B68EE;
    --primary-lighter: #9B8BFF;
    --secondary-color: #6A5ACD;
    --success-color: #28a745;
    --info-color: #17a2b8;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
}

/* Hero Section */
.hero-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    background-color: rgba(72, 61, 139, 0.9);
}

.hero-content {
    position: relative;
    z-index: 1;
}

.hero-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.hero-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.info-item {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: center;
}

.info-label {
    font-size: 0.85rem;
    opacity: 0.8;
    font-weight: 500;
}

.info-value {
    font-weight: 600;
    font-size: 0.95rem;
}

/* Cards Modernos */
.main-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(72, 61, 139, 0.1);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.main-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card-header {
    background: var(--primary-color);
    color: white;
    padding: 1rem 1.5rem;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Formulário */
.form-label {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(72, 61, 139, 0.25);
}

/* Estilização dos badges */
.combustivel-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.combustivel-gasolina { background-color: #ff6b6b; color: white; }
.combustivel-etanol { background-color: #4ecdc4; color: white; }
.combustivel-diesel { background-color: #45b7d1; color: white; }
.combustivel-flex { background-color: #96ceb4; color: white; }
.combustivel-gnv { background-color: #ffeaa7; color: #2d3436; }
.combustivel-eletrico { background-color: #6c5ce7; color: white; }

.categoria-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.categoria-veiculo_leve { background-color: #4FCADB; color: white; }
.categoria-veiculo_pesado { background-color: #FFD93D; color: #2c3e50; }
.categoria-implemento { background-color: #52C585; color: white; }
.categoria-equipamento { background-color: #8B7ED8; color: white; }

.custo-destaque {
    font-size: 1.1rem;
    font-weight: 600;
    color: #28a745;
}

/* Botões */
.btn {
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

/* Badges */
.badge {
    font-weight: 500;
    border-radius: 6px;
}

/* Responsividade */
@media (max-width: 768px) {
    .hero-title {
        font-size: 1.5rem;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .card-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

/* Animações */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.main-card {
    animation: fadeIn 0.5s ease-out;
}

/* Alertas customizados */
.alert {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Tabela compacta */
.table td, .table th {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

.table tbody tr {
    height: auto;
}

.table .btn-group {
    display: flex;
    gap: 0.25rem;
}

.btn-sm-custom {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 4px;
}
</style>

<script>
// JavaScript para Cadastro de Veículos
document.addEventListener('DOMContentLoaded', function() {
    // Intercepta eventos HTMX para mostrar feedback
    document.addEventListener('htmx:beforeRequest', function(evt) {
        const btn = evt.detail.elt;
        if (btn.tagName === 'BUTTON') {
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            btn.dataset.originalText = originalText;
        }
    });

    document.addEventListener('htmx:afterRequest', function(evt) {
        const btn = evt.detail.elt;
        if (btn.tagName === 'BUTTON' && btn.dataset.originalText) {
            btn.disabled = false;
            btn.innerHTML = btn.dataset.originalText;
            delete btn.dataset.originalText;
        }
        
        // Atualizar contador de veículos após operações CRUD
        if (evt.detail.target && evt.detail.target.id === 'lista-veiculos') {
            updateVehicleCounter();
            // Inicializar tooltips após atualização da tabela
            setTimeout(initializeTooltips, 100);
            
            // Verificar se foi uma operação bem-sucedida
            if (evt.detail.xhr.status === 200 && evt.detail.requestConfig.verb === 'post') {
                const url = evt.detail.requestConfig.path;
                if (url.includes('/editar/')) {
                    showAlert('success', 'Veículo editado com sucesso!');
                    // Limpar o formulário de edição
                    setTimeout(() => {
                        const form = document.getElementById('veiculo-form');
                        if (form) {
                            form.innerHTML = '';
                        }
                    }, 100);
                } else if (url.includes('/excluir/')) {
                    showAlert('success', 'Veículo excluído com sucesso!');
                } else if (url.includes('/cadastrar/')) {
                    showAlert('success', 'Veículo cadastrado com sucesso!');
                    // Limpar o formulário de cadastro
                    setTimeout(() => {
                        const form = document.getElementById('veiculo-form');
                        if (form) {
                            form.innerHTML = '';
                        }
                    }, 100);
                }
            }
        }
        
        // Se houve erro, mostra mensagem
        if (evt.detail.xhr.status >= 400) {
            console.log('Erro HTMX:', evt.detail.xhr.status, evt.detail.xhr.responseText);
            try {
                const response = JSON.parse(evt.detail.xhr.responseText);
                if (response.error) {
                    showAlert('danger', response.error);
                } else {
                    showAlert('danger', `Erro ${evt.detail.xhr.status}: ${evt.detail.xhr.responseText}`);
                }
            } catch(e) {
                showAlert('danger', `Erro ao processar solicitação (${evt.detail.xhr.status}): ${evt.detail.xhr.responseText}`);
            }
        }
    });

    // Função para atualizar contador de veículos
    function updateVehicleCounter() {
        const rows = document.querySelectorAll('#lista-veiculos tbody tr');
        const count = rows.length;
        const contador = document.getElementById('contador-veiculos');
        if (contador) {
            const plural = count !== 1 ? 's' : '';
            contador.textContent = `${count} veículo${plural}`;
        }
    }

    // Função para inicializar tooltips
    function initializeTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // Função para mostrar alertas
    function showAlert(type, message) {
        let icon = 'info-circle';
        if (type === 'danger') icon = 'exclamation-triangle';
        else if (type === 'success') icon = 'check-circle';
        else if (type === 'warning') icon = 'exclamation-triangle';
        
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Remove automaticamente após 5 segundos
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }

    // Inicializar tooltips na primeira carga
    initializeTooltips();
});
</script>

{% endblock %}